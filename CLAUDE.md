# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SDI API is a NestJS-based REST API for the SDI (Sistema de Dados Integrados) system. It provides endpoints for managing business operations including orders, inventory, customers, products, and financial data. The API connects to a Firebird database and is designed to be packaged as a standalone Windows executable.

## Development Commands

### Core Development
```bash
npm run start:dev    # Development with auto-reload
npm run start        # Standard development mode
npm run start:prod   # Production mode
npm run build        # Compile TypeScript to JavaScript
```

### Testing
```bash
npm test            # Run unit tests
npm run test:watch  # Run tests in watch mode
npm run test:cov    # Run tests with coverage
npm run test:e2e    # Run end-to-end tests
```

### Code Quality
```bash
npm run lint        # ESLint with auto-fix
npm run format      # Prettier formatting
```

### Production Build & Packaging
```bash
npm run build:prod       # Complete build + executable + ZIP package
npm run build:release    # Same as build:prod
npm run pkg              # Create Windows executable (requires prior build)
npm run release          # Create ZIP package (requires executable)
npm run release:full     # ZIP with ALL photos included
npm run release:dev      # ZIP with development files
```

### Platform-specific Executables
```bash
npm run pkg:win     # Windows x64 executable
npm run pkg:linux   # Linux x64 executable  
npm run pkg:macos   # macOS x64 executable
npm run pkg:debug   # Debug version with detailed logging
```

## Architecture Overview

### Database Layer
- **Firebird Database**: Primary data storage using Firebird 2.5
- **Connection**: Configured via `DBSDI.INI` file (must exist in executable directory)
- **Client**: Custom `FirebirdClient` class in `src/firebird/firebird.client.ts`
- **Configuration**: Database path and credentials read from `DBSDI.INI`

### Module Structure
The API follows NestJS modular architecture with domain-specific modules:

- **Auth**: JWT-based authentication (`src/Auth/`)
- **Business Modules**: 
  - `comanda` - Order management
  - `estoque` - Inventory management  
  - `client` - Customer management
  - `product` - Product catalog
  - `price_table` - Pricing management
  - `order` - Order processing
  - `photos` - Image management
  - `company` - Company data
  - `city`, `banks`, `payment_methods`, `transporters` - Reference data
  - `unit_measurement`, `product_unit` - Product specifications
  - `config` - System configuration

### Key Components
- **SSL/HTTPS**: Configured with certificates in `certificate/` directory
- **Swagger Documentation**: Available at `/docs/swagger`
- **Request Timeout**: 5-minute timeout for all requests
- **CORS**: Enabled for cross-origin requests
- **Logging**: Custom logging system with monthly log rotation in `logs/` directory

### Common Utilities (`src/commons.ts`)
- `buscaParametro()` - Parameter retrieval from database
- `buscaUsuario()` - User authentication queries
- `buscaVendedor()` - Sales representative queries
- `arredondarPreco()` - Price rounding logic
- `saveLog()` - Application logging
- `normalizeName()`, `normalizePhoneNumber()`, `formatClientFields()` - Data formatting

## File Structure Requirements

### Required Files for Deployment
- **Executable**: `sdiApi_V_X.X.X.exe` (generated by pkg)
- **Database Config**: `DBSDI.INI` (must be in same directory as executable)
- **SSL Certificates**: `certificate/key.pem` and `certificate/cert.pem`
- **Photos Directory**: `Fotos/` (contains all product/client images)

### Packaging Configuration
The project uses `@yao-pkg/pkg` for creating executables:
- **Target**: Node.js 22, Windows x64
- **Compression**: Brotli compression (reduces size from ~90MB to ~35MB)
- **Assets**: Automatically includes certificates and Swagger files
- **External Files**: Photos and database config remain external for easier updates

## Database Configuration

The `DBSDI.INI` file must contain:
```ini
[INICIALIZACAO]
CAMINHO_GDB=C:\Path\To\Database\
NOME_GDB=DATABASE_NAME.FDB
USER_NAME=SYSDBA
PASSWORD=encrypted_password
```

## Development Guidelines

### TypeScript Configuration
- Strict mode enabled with comprehensive ESLint rules
- Path aliases configured for clean imports (e.g., `@modules/`, `@config/`)
- Prettier integration for consistent formatting

### Error Handling
- Use NestJS exception filters and built-in HTTP exceptions
- Database errors are caught and transformed to appropriate HTTP responses
- Custom logging for debugging and audit trails

### Testing Structure
- Unit tests: `*.spec.ts` files alongside source files
- E2E tests: `test/` directory with separate Jest configuration
- Coverage reports generated in `coverage/` directory

## Deployment Notes

### Windows Executable Deployment
1. Run `npm run build:release` to create complete package
2. Extract ZIP file on target Windows server
3. Ensure `DBSDI.INI` is configured for target database
4. Verify `Fotos/` directory contains all required images
5. Execute the `.exe` file (runs on HTTPS port 3000 by default)

### Development vs Production
- Development: Uses hot reload with file watching
- Production: Single executable with embedded Node.js runtime
- Both modes require the same external files (DBSDI.INI, certificates, photos)